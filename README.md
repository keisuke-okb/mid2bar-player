<div align="center">
  <img src="./images/ui/MID2BAR.ico" alt="Repository Icon" width="100" />
  <p style="font-weight: bold;">MID2BAR-Player</p>
</div>

<div align="center">

[![Python Version](https://img.shields.io/badge/python-3.9~-blue.svg)](https://www.python.org/)
[![Code style](https://img.shields.io/badge/code%20style-black-black)](https://github.com/psf/black)
[![GitHub Release](https://img.shields.io/github/v/release/keisuke-okb/mid2bar-player)](https://github.com/keisuke-okb/mid2bar-player/releases)
[![Downloads](https://img.shields.io/github/downloads/keisuke-okb/mid2bar-player/total)](https://github.com/keisuke-okb/mid2bar-player/releases)


</div>

A standalone karaoke player that generates karaoke subtitle videos using ruby-annotated LRC lyric files, melody MIDI data, and background videos.

## 概要

- **MID2BAR-Player**: MIDIのメロディ情報とLRC（ルビ対応）歌詞、任意の背景動画／音声を組み合わせてカラオケ表示・可視化するスタンドアロンプレイヤーです。
- **主な機能**: 譜割り（区切り）を作成したメロディーMIDIファイルと歌詞と同期表示、表示エフェクト（ノートバー、グロー、パーティクル）、マイク入力によるリアルタイム採点（実際のカラオケ機器のものとは異なり、音程の一致度のみを算出しています。参考程度とお考え下さい。）、映像の重ね合わせ、録画（エクスポート）機能。


### 動作環境

- OS: Windows 11
- ディスプレイ：Full HD(1920x1080)以上の解像度
- 外部ソフトウェア：ffmpeg (画面の録画機能を使用する場合。ffmpeg.exe, ffprove.exeがあるフォルダを環境変数に登録するか、当アプリケーションのあるフォルダ直下に配置してください。)


## サンプルプロジェクトを使ったチュートリアル（ビルド済みパッケージ）

1. `MID2BAR-Player.exe` を起動します。
2. 「ファイル＞プロジェクトを開く」メニューから、「sample/sample_project.json」を読み込むと以下の設定がサンプルの音楽に設定されます。
	- 音声ファイル（例: WAV / MP3など）
	- MIDIファイル（.mid）
	- 歌詞ファイル（LRC, 拡張ルビ形式）
	- 背景動画（任意）
3. 画面下の「設定を適用して再生」を押すと、カラオケ字幕動画の再生の準備が始まります。読み込みが完了すると、歌詞のプレビュー生成など初期処理が行われます（生成中はメッセージが表示されます）。
4. 準備が完了した後、スペースキーを押して再生を開始します。


## 使い方（ソースコード）

1. 仮想環境などでMID2BAR-Player向けの環境を作成してください。

```powershell
PS> git clone https://github.com/keisuke-okb/mid2bar-player
PS> cd mid2bar-player
PS> python -m venv venv
PS> .\venv\Scripts\Activate.ps1
```


```powershell
(venv) PS> pip install -r requirements.txt
```

2. `python main_gui.py`を実行するとビルド済みパッケージと同様に設定を行い、プレイヤーを起動できます。
3. `main.py`を参考として、ほかのPythonプログラムからMID2BAR-Playerを呼び出すことも可能です。


## 手元のデータを使ってカラオケ動画を作成する手順

### 1. ルビ付きのLRC歌詞ファイルを作成

サンプルの歌詞ファイルをもとに、「RhythmicaLyrics」などを用いて拡張ルビ規格のLRCファイルを作成してください。
**「①」「②」などをタイムタグで挟むと、パート分けとして認識します。**
パート分け時のアイコンや色の設定は**歌詞字幕用の設定ファイル**（デフォルトは「lyrics_settings/settings_default.json」）で変更することが可能です。

- `sample/【音楽：魔王魂】シャイニングスター（ショート）.lrc`：通常の歌詞ファイル
- `【音楽：魔王魂】シャイニングスター（ショート）_パート字幕.lrc`：パート分け字幕（実際の曲とは異なり、記法の参照用です）

当ソフトウェアは、空白行を歌詞ブロックの区切りとして認識します。例えば、最初の２行は一つのブロックになります：
```
[00:09:65]た[00:09:83]だ[00:10:39]風[00:10:39]([00:10:39]かぜ[00:11:17])[00:11:17]に[00:11:37]揺[00:11:37]([00:11:37]ゆ[00:11:54])[00:11:54]ら[00:11:71]れ[00:11:90]て[00:12:48]
[00:12:66]何[00:12:66]([00:12:66]なに[00:13:02])[00:13:02]も[00:13:19]考[00:13:19]([00:13:19]かんが[00:14:19])[00:14:19]え[00:14:57]ず[00:14:75]に[00:15:48]
```

途中空白を挟まず３行連続している箇所は、３行をまとめて一つのブロックとして認識します。

```
[00:35:29]シャ[00:35:45]イ[00:35:61]ニ[00:35:76]ン[00:35:94]グ[00:36:09]ス[00:36:24]ター[00:36:58]綴[00:36:58]([00:36:58]つづ[00:37:30])[00:37:30]れ[00:37:49]ば[00:37:94]
[00:38:10]夢[00:38:10]([00:38:10]ゆめ[00:38:46])[00:38:46]に[00:38:66]眠[00:38:66]([00:38:66]ねむ[00:39:22])[00:39:22]る[00:39:64]幻[00:39:64]([00:39:64]まぼろし[00:40:77])[00:40:77]が[00:41:00][00:41:38]掌[00:41:38]([00:41:38]てのひら[00:42:29])[00:42:29]に[00:42:67]降[00:42:67]([00:42:67]ふ[00:43:04])[00:43:04]り[00:43:41]注[00:43:41]([00:43:41]そそ[00:43:96])[00:43:96]ぐ[00:44:44]
[00:44:56]新[00:44:56]([00:44:56]あら[00:44:91])[00:44:91]た[00:45:29]な[00:45:66]世[00:45:66]([00:45:66]せ[00:46:07])[00:46:07]界[00:46:07]([00:46:07]かい[00:46:63])[00:46:63]へ[00:47:19]
```

### 2. メロディーMIDIデータの音程バー表示区切りを作成

1. `MIDI Marker Editor.exe`を実行し、メニュー「File＞Open MIDI...」を押して表示させたいメロディラインのMIDIデータを読み込みます。**誤動作を避けるため、主旋律のMIDIチャンネルは0に設定してください。**
2. 同期した音源データを「File＞Set reference audio...」メニューから選択し、再生ボタンを押すと音源が再生され、現在位置が動くことを確認します。
3. 音程バーを表示する両端の区切りを挿入したい箇所でダブルクリックすると、マーカーが挿入されます。
4. 「File＞Save MIDI with markers...」メニューを押して、マーカーが挿入されたメロディーラインのMIDIファイルを保存します。
5. `MID2BAR-Player`本体で書き出したMIDIファイルを指定します。


### 3. （オプション）各種画像データ、設定ファイルの準備

その他、プレイヤーに表示する画像や詳細な設定を変更できます。

- スプラッシュ画像：再生冒頭、プレイヤー全体に表示する画像
- タイトルロゴ画像：再生冒頭、プレイヤーの中心に表示する画像（曲名を想定）
- 音源：MP3など、プレイヤーで再生する音楽ファイル
- カラオケ字幕生成の設定：字幕生成の詳細設定（デフォルトは`lyrics_settings/settings_default.json`）
- プレイヤー全般設定：MID2BAR-Playerの表示にかかわる全般の設定（デフォルトは`app_settings/settings.json`）
- 画像素材設定：MID2BAR-Playerで使用する画像素材の設定（デフォルトは`app_settings/assets.json`）


## 基本操作（キーボード・マウス）

- **Space**: 再生 / 一時停止
- **R**: 再スタート（先頭から再生）
- **A**: 小節の自動再生（Bar Auto Play）ON/OFF
- **M**: マイク入力（リアルタイム採点）ON/OFF
- **F11**: フルスクリーン切替
- **↑ / ↓**: 音量調整
- **ESC**: 終了
- **マウス左クリック**: メニューの表示、再生位置をシーク（シークバー上）


## 録画（動画出力）

- `ffmpeg`を利用して、プレイヤーの映像をMP4動画として書き出すことができます。
- 録画を有効にして起動すると、再生中の映像と音声を合成して動画出力できます。
- 録画中は、画面を操作しないでください。


## トラブルシューティング

- 音が出ない場合: システムの音量、Pygameが使用するオーディオデバイス、ファイル形式を確認してください。
- マイクが反応しない場合: マイクがシステムで有効か、アプリにマイク許可があるかを確認してください。


## マイク入力とリアルタイム採点（参考程度の機能）

- 設定でマイク入力をONにして起動するか、再生中に `M` でマイク入力を有効にすると、FFTベースのピッチ検出により歌声を解析してノートとの一致度やピッチ精度をページ単位で算出します。
- 画面をクリックしてメニューを表示すると、リアルタイムで点数を確認できます。
- マイク入力の閾値や遅延補正などのパラメータは設定ファイル（`app_settings/settings.json`）で調整できます。


## ライセンス

- リポジトリに含まれる各種ファイルのうち、別途ファイル名にライセンスが明記されていないファイルはすべてリポジトリの `LICENSE` に基づきます。
- `sample/`に含まれるサンプル音楽の著作権は[森田交一（魔王魂）](https://maou.audio/)に帰属します。
- 本リポジトリのプログラム（改変含む）またはビルド済みパッケージを利用して作成した動画を動画投稿サイトにアップロードすることが可能です。その際は、使用したソフトウェアとして「MID2BAR-Player」と表記をお願いいたします。また、作成した動画のアップロードによって生じた問題についてはいかなる責任を負いかねますのでご注意ください。


## 設定一覧